# 修复 FinBert 前端显示问题

您遇到的问题是前端没有正确显示各章节的文本内容及其对应的情感分析结果。从您提供的代码中，我发现了几个可能的问题点和解决方案。

## 问题诊断

1. **数据流问题**: 您的系统虽然提取了 4 个章节，但前端可能没有正确接收或处理这些数据
2. **渲染逻辑问题**: 章节内容可能未被正确渲染为单独的句子
3. **情感标记未应用**: CSS 样式定义正确，但可能未被正确应用

## 解决方案

### 1. 首先修复后端 API 返回格式

确保后端 API 返回的数据结构符合前端期望:

```python
# 在app.py文件中确保sections中包含sentences
section_results = analyzer.analyze_batch(valid_sents)
section_sentences[item_name] = [
    {
        "text": sent,
        "label": result["label"],
        "confidence": result["confidence"]
    }
    for sent, result in zip(valid_sents, section_results)
]
```

### 2. 添加调试输出到 ReportDetail.vue

在模板部分添加调试信息，帮助您了解数据加载状态:

```vue
<!-- 在report-content div的开始处添加 -->
<div
  v-if="store.currentReport"
  class="debug-info"
  style="margin-bottom: 20px; padding: 10px; background: #f0f9eb; border-radius: 4px;"
>
  <p><strong>调试信息</strong></p>
  <p>章节数量: {{ Object.keys(store.currentReport.sections).length }}</p>
  <p>章节列表: {{ Object.keys(store.currentReport.sections).join(', ') }}</p>
  <p v-if="activeSection">当前章节句子数: {{ store.currentReport.sections[activeSection]?.sentences?.length || 0 }}</p>
</div>
```

### 3. 修改章节句子显示逻辑

使用 SentenceExplanation 组件替代简单的 div 渲染，提供更丰富的展示:

```vue
<!-- 修改sentences-container部分 -->
<div class="sentences-container">
  <template v-if="sectionData.sentences && sectionData.sentences.length > 0">
    <sentence-explanation
      v-for="(sentence, index) in sectionData.sentences"
      :key="index"
      :sentence="sentence"
      @click="selectSentence(sentence)"
    />
  </template>
  <el-empty v-else description="没有句子数据" />
</div>
```

### 4. 导入 SentenceExplanation 组件

```vue
<script lang="ts">
import { defineComponent, ref, computed, onMounted } from "vue";
import { useRoute, useRouter } from "vue-router";
import { useReportStore } from "@/store/report";
import { SectionSentence } from "@/services/api";
import SentenceExplanation from "@/components/SentenceExplanation.vue";
// 其他导入...

export default defineComponent({
  name: "ReportDetail",
  components: {
    VChart,
    SentenceExplanation,
  },
  // ...其他代码
});
</script>
```

### 5. 检查报告加载逻辑

```javascript
// 修改onMounted部分，添加错误处理和日志
onMounted(async () => {
  if (ticker.value && date.value) {
    try {
      console.log(`加载报告: ${ticker.value} ${date.value}`);
      await store.fetchReportDetails(ticker.value, date.value);

      console.log("报告数据:", store.currentReport);

      // 设置初始激活章节
      if (store.currentReport && store.currentReport.sections) {
        const sectionNames = Object.keys(store.currentReport.sections);
        console.log("可用章节:", sectionNames);

        if (sectionNames.length > 0) {
          activeSection.value = sectionNames[0];
          console.log("设置默认章节:", activeSection.value);
        }
      } else {
        console.error("报告数据无效或缺少章节");
      }
    } catch (error) {
      console.error("加载报告出错:", error);
    }
  }
});
```

### 6. 添加后台分析触发按钮

在某些情况下，可能需要强制重新分析:

```vue
<!-- 在report-summary后添加 -->
<div class="actions-bar" style="margin-bottom: 20px; text-align: right;">
  <el-button 
    type="primary" 
    size="small" 
    @click="forceAnalyze"
    :loading="analyzing"
  >
    重新分析报告
  </el-button>
</div>

<!-- 在script中添加 -->
const analyzing = ref(false); const forceAnalyze = async () => { try {
analyzing.value = true; await store.fetchReportDetails(ticker.value, date.value,
true); ElMessage.success('报告重新分析完成'); } catch (error) {
ElMessage.error('分析失败: ' + error); } finally { analyzing.value = false; } };
```

## 应用这些更改后

实施上述修改后，您的前端应该能够正确显示每个章节的句子，并根据情感分析结果用不同颜色标记（绿色/利好，灰色/中性，红色/利空）。每句话还可以点击查看详细的情感分析结果。

如果问题仍然存在，您可能需要:

1. 检查网络请求，确保 API 正确返回数据
2. 检查 data/processed 目录下是否有正确提取的文本文件
3. 检查后端日志，寻找可能的错误信息

希望这些修改能解决您的前端显示问题！
